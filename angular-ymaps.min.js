angular.module("ymaps",[]).factory("$script",["$q","$rootScope",function(a,b){"use strict";function c(a,b){var c=document.createElement("script");c.onload=c.onreadystatechange=function(){return c.readyState&&"complete"!==c.readyState&&"loaded"!==c.readyState?!1:(c.onload=c.onreadystatechange=null,angular.isFunction(b)&&b(),void 0)},c.async=!0,c.src=a,document.getElementsByTagName("body")[0].appendChild(c)}var d=[],e={};return function(f){var g=a.defer();if(-1!==d.indexOf(f))g.resolve();else{if(e[f])return e[f];c(f,function(){delete e[f],d.push(f),b.$apply(function(){g.resolve()})}),e[f]=g.promise}return g.promise}}]).factory("ymapsLoader",["$script","ymapsConfig",function(a,b){"use strict";var c=a(b.apiUrl).then(function(){return ymaps});return{ready:function(a){c.then(function(b){b.ready(function(){a(b)})})}}}]).constant("ymapsConfig",{apiUrl:"//api-maps.yandex.ru/2.0-stable/?load=package.standard,package.clusters&mode=release&lang=ru-RU&ns=ymaps",mapBehaviors:["default"],markerOptions:{preset:"twirl#darkgreenIcon"},fitMarkers:!0}).controller("YmapController",["$scope","$element","ymapsLoader","ymapsConfig",function(a,b,c,d){"use strict";function e(a,b){function c(a,b){var c=null;return function(){var d=this,e=arguments,f=function(){c=null,a.apply(d,e)};clearTimeout(c),c=setTimeout(f,b)}}var d=.1,e=c(function(b){var c=b.get("newBounds"),e=[c[1][0]+d,c[1][1]+d],f=[c[0][0]-d,c[0][1]-d];a.setBounds([f,e],{checkZoomRange:!0})},100);b.events.add("boundschange",e)}var f=this;c.ready(function(c){f.addMarker=function(b,d){var e=new c.Placemark(b,d);return a.markers.add(e),e},f.removeMarker=function(b){a.markers.remove(b)},a.map=new c.Map(b[0],{center:a.center||[0,0],zoom:a.zoom||0,behaviors:d.mapBehaviors}),a.map.controls.add("zoomControl",{right:5,top:10}),a.markers=new c.GeoObjectCollection({},d.markerOptions),a.map.geoObjects.add(a.markers),d.fitMarkers&&e(a.map,a.markers);var g;a.$watch("center",function(b){g||a.map.panTo(b)},!0),a.$watch("zoom",function(b){g||a.map.setZoom(b,{checkZoomRange:!0})}),a.map.events.add("boundschange",function(b){g=!0,a.$apply(function(){a.center=b.get("newCenter"),a.zoom=b.get("newZoom")}),g=!1})})}]).directive("yandexMap",["$compile","ymapsLoader",function(a,b){"use strict";return{restrict:"EA",scope:{center:"=",zoom:"="},compile:function(c){var d=c.contents();return c.html(""),function(c,e){b.ready(function(){e.append(d),c.$apply(function(){a(d)(c.$parent)})})}},controller:"YmapController"}}]).directive("ymapMarker",function(){"use strict";return{restrict:"EA",require:"^yandexMap",scope:{coordinates:"=",index:"=",properties:"="},link:function(a,b,c,d){function e(){var b=[parseFloat(a.coordinates[0]),parseFloat(a.coordinates[1])];f?f.geometry.setCoordinates(b):f=d.addMarker(b,angular.extend({iconContent:a.index},a.properties))}var f;a.$watch("index",function(a){f&&f.properties.set("iconContent",a)}),a.$watch("coordinates",function(a){a&&e()},!0),a.$on("$destroy",function(){f&&d.removeMarker(f)})}}});