angular.module("ymaps",[]).factory("$script",["$q","$rootScope",function(a,b){"use strict";function c(a,b){var c=document.createElement("script");c.onload=c.onreadystatechange=function(){return c.readyState&&"complete"!==c.readyState&&"loaded"!==c.readyState?!1:(c.onload=c.onreadystatechange=null,angular.isFunction(b)&&b(),void 0)},c.async=!0,c.src=a,document.getElementsByTagName("body")[0].appendChild(c)}var d=[],e={};return{get:function(f){var g=a.defer();if(-1!==d.indexOf(f))g.resolve();else{if(e[f])return e[f];c(f,function(){delete e[f],d.push(f),b.$apply(function(){g.resolve()})}),e[f]=g.promise}return g.promise}}}]).constant("ymapConfig",{mapBehaviors:["default"],markerOptions:{preset:"twirl#darkgreenIcon"},fitMarkers:!0}).controller("YmapController",["$scope",function(a){"use strict";this.addMarker=function(b,c){var d=new ymaps.Placemark(b,c);return a.markers.add(d),d},this.removeMarker=function(b){a.markers.remove(b)}}]).directive("yandexMap",["$compile","$script","ymapConfig",function(a,b,c){"use strict";function d(a,b){function c(a,b){var c=null;return function(){var d=this,e=arguments,f=function(){c=null,a.apply(d,e)};clearTimeout(c),c=setTimeout(f,b)}}var d=.1,e=c(function(b){var c=b.get("newBounds"),e=[c[1][0]+d,c[1][1]+d],f=[c[0][0]-d,c[0][1]-d];a.setBounds([f,e],{checkZoomRange:!0})},100);b.events.add("boundschange",e)}return{restrict:"EA",scope:{center:"=",zoom:"="},compile:function(e){var f=e.contents();return e.html(""),function(e,g){b.get("//api-maps.yandex.ru/2.0.30/?load=package.standard,package.clusters&mode=release&lang=ru-RU&ns=ymaps").then(function(){ymaps.ready(function(){e.map=new ymaps.Map(g[0],{center:e.center||[0,0],zoom:e.zoom||0,behaviors:c.mapBehaviors}),e.map.controls.add("zoomControl",{right:5,top:10}),e.markers=new ymaps.GeoObjectCollection({},c.markerOptions),e.map.geoObjects.add(e.markers),c.fitMarkers&&d(e.map,e.markers),g.append(f),e.$apply(function(){a(f)(e.$parent)})})})}},controller:"YmapController"}}]).directive("ymapMarker",function(){"use strict";return{restrict:"EA",require:"^yandexMap",scope:{coordinates:"=",index:"=",properties:"="},link:function(a,b,c,d){function e(){var b=[parseInt(a.coordinates[0],10),parseInt(a.coordinates[1],10)];f?f.geometry.setCoordinates(b):f=d.addMarker(b,angular.extend({iconContent:a.index},a.properties))}var f;a.$watch("index",function(a){f&&f.properties.set("iconContent",a)}),a.$watch("coordinates",function(a){a&&e()},!0),a.$on("$destroy",function(){f&&d.removeMarker(f)})}}});